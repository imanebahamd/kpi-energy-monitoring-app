<div class="container mt-4">
  <h2>Saisie des données électriques</h2>

  <form [formGroup]="electricityForm" (ngSubmit)="onSubmit()" class="mt-4">
    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">Année</label>
        <input type="number" class="form-control" formControlName="year" min="2000" max="2100">
        <div *ngIf="electricityForm.get('year')?.invalid && electricityForm.get('year')?.touched" class="text-danger">
          L'année doit être entre 2000 et 2100
        </div>
      </div>

      <div class="col-md-3">
        <label class="form-label">Mois</label>
        <select class="form-select" formControlName="month">
          <option *ngFor="let m of [1,2,3,4,5,6,7,8,9,10,11,12]" [value]="m">{{ m }}</option>
        </select>
        <div *ngIf="electricityForm.get('month')?.invalid && electricityForm.get('month')?.touched" class="text-danger">
          Sélectionnez un mois valide
        </div>
      </div>
    </div>

    <!-- 60KV Network -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        Réseau 60KV
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Énergie Active (KWh)</label>
            <input type="number" class="form-control" formControlName="network60kvActiveEnergy" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network60kvActiveEnergy')?.invalid && electricityForm.get('network60kvActiveEnergy')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Énergie Réactive (KVARh)</label>
            <input type="number" class="form-control" formControlName="network60kvReactiveEnergy" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network60kvReactiveEnergy')?.invalid && electricityForm.get('network60kvReactiveEnergy')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Pointe du mois (KW)</label>
            <input type="number" class="form-control" formControlName="network60kvPeak" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network60kvPeak')?.invalid && electricityForm.get('network60kvPeak')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-6">
            <div class="alert alert-info">
              <strong>Facteur de puissance (cosφ):</strong>
              {{ calculated60kvPowerFactor ? (calculated60kvPowerFactor | number:'1.3-3') : '--' }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-warning">
              <strong>Limite cosφ:</strong> ≥ 0.9
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 22KV Network -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        Réseau 22KV
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label class="form-label">Énergie Active (KWh)</label>
            <input type="number" class="form-control" formControlName="network22kvActiveEnergy" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network22kvActiveEnergy')?.invalid && electricityForm.get('network22kvActiveEnergy')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Énergie Réactive (KVARh)</label>
            <input type="number" class="form-control" formControlName="network22kvReactiveEnergy" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network22kvReactiveEnergy')?.invalid && electricityForm.get('network22kvReactiveEnergy')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Pointe du mois (KW)</label>
            <input type="number" class="form-control" formControlName="network22kvPeak" step="0.01" min="0">
            <div *ngIf="electricityForm.get('network22kvPeak')?.invalid && electricityForm.get('network22kvPeak')?.touched" class="text-danger">
              Valeur positive requise
            </div>
          </div>
        </div>

        <div class="row mt-2">
          <div class="col-md-6">
            <div class="alert alert-info">
              <strong>Facteur de puissance (cosφ):</strong>
              {{ calculated22kvPowerFactor ? (calculated22kvPowerFactor | number:'1.3-3') : '--' }}
            </div>
          </div>
          <div class="col-md-6">
            <div class="alert alert-warning">
              <strong>Limite cosφ:</strong> ≥ 0.8
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total -->
    <div class="card mb-4">
      <div class="card-header bg-secondary text-white">
        Total
      </div>
      <div class="card-body">
        <div class="alert alert-primary">
          <strong>Total énergie active:</strong>
          {{ totalActiveEnergy ? (totalActiveEnergy | number:'1.2-2') + ' KWh' : '--' }}
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between mt-4">
      <button type="submit" class="btn btn-primary" [disabled]="electricityForm.invalid || isLoading">
        <span *ngIf="!isLoading">Enregistrer</span>
        <span *ngIf="isLoading" class="spinner-border spinner-border-sm"></span>
      </button>

      <div>
        <a routerLink="/admin/electricity-monthly" class="btn btn-outline-info me-2">
          Consulter le tableau mensuel
        </a>
        <a routerLink="/admin/electricity-annual" class="btn btn-outline-info me-2">
          Consulter le tableau annuel
        </a>
        <a routerLink="/admin/electricity-graphs" class="btn btn-outline-success">
          Visualisation graphique
        </a>
      </div>
    </div>

    <div *ngIf="message" class="alert mt-3" [ngClass]="{'alert-success': !isLoading, 'alert-danger': isLoading && message.includes('Erreur')}">
      {{ message }}
    </div>
  </form>
</div>

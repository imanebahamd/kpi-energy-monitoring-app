<div class="monthly-summary">
  <!-- Alert message -->
  <div *ngIf="showAlert" class="dynamic-alert" [ngClass]="alertType">
    {{ alertMessage }}
  </div>

  <div class="header">
    <h1>
      <i class="icon lightning"></i>
      Rapport Mensuel Électrique
    </h1>
    <div class="header-actions">
      <a [routerLink]="[getRoutePrefix(), 'electricity-saisie']" class="button">
        <i class="icon add"></i> Saisir Nouvelles Données
      </a>
      <a [routerLink]="[getRoutePrefix(), 'electricity-annual']" class="button">
        <i class="icon calendar"></i> Vue Annuelle
      </a>
      <a [routerLink]="[getRoutePrefix(), 'electricity-graphs']" class="button">
        <i class="icon chart"></i> Visualisation Graphique
      </a>
    </div>
  </div>

  <div class="info-message">
    <i class="icon info"></i>
    <p>Cette page vous permet de consulter les données électriques mensuelles. Sélectionnez une année et un mois spécifique, ou choisissez une période pour afficher plusieurs mois. Vous pouvez également modifier ou supprimer les données existantes.</p>
  </div>

  <div class="filters">
    <div class="filter-group">
      <label for="year">Année</label>
      <input id="year" type="number" [(ngModel)]="year"
             (change)="onFilterChange()"
             min="2000" max="2100"
             placeholder="Entrez l'année">
    </div>

    <div class="filter-group" *ngIf="!showPeriodSelection">
      <label for="month">Mois</label>
      <select id="month" [(ngModel)]="month" (change)="onFilterChange()">
        <option [ngValue]="null" disabled>Choisissez un mois</option>
        <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
      </select>
    </div>

    <div class="filter-group" *ngIf="showPeriodSelection">
      <label>De</label>
      <select [(ngModel)]="startMonth" (change)="onFilterChange()">
        <option [ngValue]="null" disabled>Mois de début</option>
        <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
      </select>
    </div>

    <div class="filter-group" *ngIf="showPeriodSelection">
      <label>À</label>
      <select [(ngModel)]="endMonth" (change)="onFilterChange()">
        <option [ngValue]="null" disabled>Mois de fin</option>
        <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
      </select>
    </div>

    <button (click)="togglePeriodSelection()" class="toggle-period">
      {{ showPeriodSelection ? 'Sélection simple' : 'Période' }}
    </button>

    <button (click)="showPeriodSelection ? loadPeriodSummary() : loadSummary()"
            [disabled]="!year || (!showPeriodSelection && !month) || (showPeriodSelection && (!startMonth || !endMonth)) || isLoading">
      <span *ngIf="!isLoading">Afficher</span>
      <span *ngIf="isLoading" class="spinner"></span>
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="!filtersTouched" class="instruction">
    <i class="icon info"></i>
    <span>Veuillez sélectionner une année et un mois (ou une période) pour afficher les données</span>
  </div>

  <div *ngIf="isLoading" class="status loading">
    <div class="spinner"></div>
    <span>Chargement en cours...</span>
  </div>

  <div *ngIf="error && filtersTouched" class="status error">
    <i class="icon warning"></i>
    <span>{{ error }}</span>
  </div>

  <!-- Tableau pour un mois unique -->
  <div *ngIf="summary && !showPeriodSelection" class="network-section">
    <div class="section-header">
      <h2><i class="icon high-voltage"></i> Données pour {{ getMonthName(month) }} {{ year }}</h2>
      <div class="section-actions">
        <a [routerLink]="['/admin/electricity-saisie']"
           [queryParams]="{year: year, month: month}"
           class="button edit">
          <i class="icon edit"></i> Modifier
        </a>
        <button (click)="deleteData(year, month)"
                [disabled]="!month"
                class="button delete">
          <i class="icon delete"></i> Supprimer
        </button>
      </div>
    </div>

    <!-- Tableau 60KV -->
    <div class="network-subsection">
      <h3>Réseau 60KV</h3>
      <table class="data-table">
        <thead>
        <tr>
          <th>Pointe (KW)</th>
          <th>Facteur de puissance</th>
          <th>Consommation (KWh)</th>
          <th>État</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td class="numeric">{{ summary.network60kvPeak | number:'1.2-2' }}</td>
          <td class="numeric">{{ summary.network60kvPowerFactor | number:'1.3-3' }}</td>
          <td class="numeric">{{ summary.network60kvConsumption | number:'1.2-2' }}</td>
          <td class="status-cell" [class]="getCosphiStatus(summary.network60kvPowerFactor, 0.9)">
            <i class="icon" [class]="getStatusIcon(getCosphiStatus(summary.network60kvPowerFactor, 0.9))"></i>
            {{ getCosphiStatus(summary.network60kvPowerFactor, 0.9) | titlecase }}
          </td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
          <td colspan="4">Limite: ≥ 0.9 | Optimal: ≈0.95</td>
        </tr>
        </tfoot>
      </table>
    </div>

    <!-- Tableau 22KV -->
    <div class="network-subsection">
      <h3>Réseau 22KV</h3>
      <table class="data-table">
        <thead>
        <tr>
          <th>Pointe (KW)</th>
          <th>Facteur de puissance</th>
          <th>Consommation (KWh)</th>
          <th>État</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td class="numeric">{{ summary.network22kvPeak | number:'1.2-2' }}</td>
          <td class="numeric">{{ summary.network22kvPowerFactor | number:'1.3-3' }}</td>
          <td class="numeric">{{ summary.network22kvConsumption | number:'1.2-2' }}</td>
          <td class="status-cell" [class]="getCosphiStatus(summary.network22kvPowerFactor, 0.8)">
            <i class="icon" [class]="getStatusIcon(getCosphiStatus(summary.network22kvPowerFactor, 0.8))"></i>
            {{ getCosphiStatus(summary.network22kvPowerFactor, 0.8) | titlecase }}
          </td>
        </tr>
        </tbody>
        <tfoot>
        <tr>
          <td colspan="4">Limite: ≥ 0.8 | Optimal: ≈0.85</td>
        </tr>
        </tfoot>
      </table>
    </div>
  </div>

  <!-- Tableau pour une période -->
  <div *ngIf="periodSummaries.length > 0 && showPeriodSelection" class="period-section">
    <h2><i class="icon calendar-range"></i> Données pour la période de {{ getMonthName(startMonth) }} à {{ getMonthName(endMonth) }} {{ year }}</h2>

    <div *ngFor="let summary of periodSummaries" class="monthly-data">
      <div class="month-header">
        <h3>{{ getMonthName(summary.month) }} {{ summary.year }}</h3>
        <div class="month-actions">
          <a [routerLink]="['/admin/electricity-saisie']"
             [queryParams]="{year: summary.year, month: summary.month}"
             class="button edit">
            <i class="icon edit"></i> Modifier
          </a>
          <button (click)="deleteData(summary.year, summary.month)"
                  class="button delete">
            <i class="icon delete"></i> Supprimer
          </button>
        </div>
      </div>

      <div class="data-grid">
        <!-- 60KV Data -->
        <div class="data-card">
          <h4>Réseau 60KV</h4>
          <div class="data-row">
            <span>Pointe:</span>
            <span class="numeric">{{ summary.network60kvPeak | number:'1.2-2' }} KW</span>
          </div>
          <div class="data-row">
            <span>Facteur de puissance:</span>
            <span class="numeric" [class]="getCosphiStatus(summary.network60kvPowerFactor, 0.9)">
              {{ summary.network60kvPowerFactor | number:'1.3-3' }}
              <i class="icon small" [class]="getStatusIcon(getCosphiStatus(summary.network60kvPowerFactor, 0.9))"></i>
            </span>
          </div>
          <div class="data-row">
            <span>Consommation:</span>
            <span class="numeric">{{ summary.network60kvConsumption | number:'1.2-2' }} KWh</span>
          </div>
        </div>

        <!-- 22KV Data -->
        <div class="data-card">
          <h4>Réseau 22KV</h4>
          <div class="data-row">
            <span>Pointe:</span>
            <span class="numeric">{{ summary.network22kvPeak | number:'1.2-2' }} KW</span>
          </div>
          <div class="data-row">
            <span>Facteur de puissance:</span>
            <span class="numeric" [class]="getCosphiStatus(summary.network22kvPowerFactor, 0.8)">
              {{ summary.network22kvPowerFactor | number:'1.3-3' }}
              <i class="icon small" [class]="getStatusIcon(getCosphiStatus(summary.network22kvPowerFactor, 0.8))"></i>
            </span>
          </div>
          <div class="data-row">
            <span>Consommation:</span>
            <span class="numeric">{{ summary.network22kvConsumption | number:'1.2-2' }} KWh</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

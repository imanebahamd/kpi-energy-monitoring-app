<div class="water-monthly-container">
  <div class="water-monthly-content">
    <!-- Alerte dynamique -->
    <div *ngIf="showAlert" class="alert-container" [attr.data-type]="alertType">
      <div class="alert-content">
        {{ alertMessage }}
      </div>
    </div>

    <!-- En-tête -->
    <header class="water-header">
      <h1 class="header-title">Tableau Mensuel de Production d'Eau</h1>

      <div class="header-actions">
        <a [routerLink]="[getRoutePrefix(), 'water-saisie']" class="btn btn-primary">
          Saisir Nouvelles Données
        </a>
        <a [routerLink]="[getRoutePrefix(), 'water-annual']" class="btn btn-info">
          Vue Annuelle
        </a>
        <a [routerLink]="[getRoutePrefix(), 'water-graphs']" class="btn btn-info">
          Visualisation Graphique
        </a>
      </div>
    </header>

    <!-- Message d'information -->
    <div class="info-card">
      <p>Cette page vous permet de consulter les données de production d'eau mensuelles. Sélectionnez une année et un mois spécifique ou une période. Vous pouvez également modifier ou supprimer les données existantes.</p>
    </div>

    <!-- Filtres principaux -->
    <div class="filters-section">
      <div class="filters-row">
        <div class="filter-group">
          <label for="year">Année</label>
          <select id="year" [(ngModel)]="selectedYear" (change)="onFilterChange()">
            <option *ngFor="let y of years" [value]="y">{{ y }}</option>
          </select>
        </div>
      </div>

      <div class="filter-actions">
        <button (click)="toggleMonthSelection()" class="btn btn-secondary">
          {{ showMonthSelection ? 'Annuler' : 'Afficher un mois précis' }}
        </button>
        <button (click)="togglePeriodSelection()" class="btn btn-secondary">
          {{ showPeriodSelection ? 'Annuler' : 'Afficher une période' }}
        </button>
      </div>

      <!-- Filtre pour un mois précis -->
      <div *ngIf="showMonthSelection" class="advanced-filters">
        <div class="filter-content">
          <div class="filter-group">
            <label>Mois</label>
            <select [(ngModel)]="selectedMonth" (change)="onFilterChange()">
              <option [ngValue]="null" disabled>Sélectionnez un mois</option>
              <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
            </select>
          </div>

          <button (click)="loadSingleMonthData()"
                  [disabled]="!selectedYear || !selectedMonth || isLoading"
                  class="btn btn-primary">
            <span *ngIf="!isLoading">Afficher</span>
            <span *ngIf="isLoading" class="loading-spinner"></span>
          </button>
        </div>
      </div>

      <!-- Filtres pour une période -->
      <div *ngIf="showPeriodSelection" class="advanced-filters">
        <div class="filter-content">
          <div class="filter-group">
            <label>Mois de début</label>
            <select [(ngModel)]="startMonth" (change)="onFilterChange()">
              <option [ngValue]="null" disabled>Sélectionnez</option>
              <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
            </select>
          </div>

          <div class="filter-group">
            <label>Mois de fin</label>
            <select [(ngModel)]="endMonth" (change)="onFilterChange()">
              <option [ngValue]="null" disabled>Sélectionnez</option>
              <option *ngFor="let m of months" [value]="m.value">{{ m.name }}</option>
            </select>
          </div>

          <button (click)="loadPeriodData()"
                  [disabled]="!selectedYear || !startMonth || !endMonth || isLoading"
                  class="btn btn-primary">
            <span *ngIf="!isLoading">Afficher</span>
            <span *ngIf="isLoading" class="loading-spinner"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Messages d'état -->
    <div *ngIf="!filtersTouched" class="status-message info">
      Veuillez sélectionner une année et un mois ou une période
    </div>

    <div *ngIf="isLoading" class="loading-container">
      <div class="loading-spinner"></div>
      <span class="loading-text">Chargement en cours...</span>
    </div>

    <div *ngIf="error && filtersTouched" class="status-message error">
      {{ error }}
    </div>

    <!-- Affichage pour un mois précis -->
    <div *ngIf="singleMonthData && showMonthSelection" class="data-section">
      <h2 class="section-title">Données pour {{ getMonthName(selectedMonth) }} {{ selectedYear }}</h2>

      <table class="data-table">
        <thead>
        <tr>
          <th>Mois</th>
          <th>F3BIS (m³)</th>
          <th>F3 (m³)</th>
          <th>SE2 (m³)</th>
          <th>SE3BIS (m³)</th>
          <th>Total Production (m³)</th>
          <th *ngIf="isAdminUser">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td>{{ getMonthName(singleMonthData.month) }}</td>
          <td>{{ singleMonthData.f3bis | number:'1.2-2' }}</td>
          <td>{{ singleMonthData.f3 | number:'1.2-2' }}</td>
          <td>{{ singleMonthData.se2 | number:'1.2-2' }}</td>
          <td>{{ singleMonthData.se3bis | number:'1.2-2' }}</td>
          <td>{{ singleMonthData.totalProduction | number:'1.2-2' }}</td>
          <td *ngIf="isAdminUser" class="actions-cell">
            <a [routerLink]="[getRoutePrefix(), 'water-saisie']"
               [queryParams]="{year: singleMonthData.year, month: singleMonthData.month}"
               class="btn btn-warning">
              Modifier
            </a>
            <button (click)="deleteData(singleMonthData.year, singleMonthData.month)"
                    class="btn btn-danger">
              Supprimer
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Affichage pour une période -->
    <div *ngIf="periodData.length > 0 && showPeriodSelection" class="data-section">
      <h2 class="section-title">Période de {{ getMonthName(startMonth) }} à {{ getMonthName(endMonth) }} {{ selectedYear }}</h2>

      <table class="data-table">
        <thead>
        <tr>
          <th>Mois</th>
          <th>F3BIS (m³)</th>
          <th>F3 (m³)</th>
          <th>SE2 (m³)</th>
          <th>SE3BIS (m³)</th>
          <th>Total Production (m³)</th>
          <th *ngIf="isAdminUser">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let item of periodData">
          <td>{{ getMonthName(item.month) }}</td>
          <td>{{ item.f3bis | number:'1.2-2' }}</td>
          <td>{{ item.f3 | number:'1.2-2' }}</td>
          <td>{{ item.se2 | number:'1.2-2' }}</td>
          <td>{{ item.se3bis | number:'1.2-2' }}</td>
          <td>{{ item.totalProduction | number:'1.2-2' }}</td>
          <td *ngIf="isAdminUser" class="actions-cell">
            <a [routerLink]="[getRoutePrefix(), 'water-saisie']"
               [queryParams]="{year: item.year, month: item.month}"
               class="btn btn-warning">
              Modifier
            </a>
            <button (click)="deleteData(item.year, item.month)"
                    class="btn btn-danger">
              Supprimer
            </button>
          </td>
        </tr>
        <tr class="total-row">
          <td>Total Période</td>
          <td>{{ calculateTotal(periodData).f3bis | number:'1.2-2' }}</td>
          <td>{{ calculateTotal(periodData).f3 | number:'1.2-2' }}</td>
          <td>{{ calculateTotal(periodData).se2 | number:'1.2-2' }}</td>
          <td>{{ calculateTotal(periodData).se3bis | number:'1.2-2' }}</td>
          <td>{{ calculateTotal(periodData).totalProduction | number:'1.2-2' }}</td>
          <td *ngIf="isAdminUser"></td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
